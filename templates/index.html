{% extends "base.html" %}
{% block title %}Inicio - Tareas PRO{% endblock %}
{% block content %}

<!-- KPIs / Dashboard -->
<div class="row g-3 mb-4">
  <div class="col-6 col-md-3">
    <div class="card border-0 shadow-soft hoverable">
      <div class="card-body">
        <div class="kpi">
          <div class="kpi-icon warning"><i class="bi bi-hourglass-split"></i></div>
          <div>
            <div class="kpi-value">{{ stats.pend or 0 }}</div>
            <div class="kpi-label">Pendientes</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card border-0 shadow-soft hoverable">
      <div class="card-body">
        <div class="kpi">
          <div class="kpi-icon info"><i class="bi bi-rocket-takeoff"></i></div>
          <div>
            <div class="kpi-value">{{ stats.prog or 0 }}</div>
            <div class="kpi-label">En progreso</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card border-0 shadow-soft hoverable">
      <div class="card-body">
        <div class="kpi">
          <div class="kpi-icon success"><i class="bi bi-check2-circle"></i></div>
          <div>
            <div class="kpi-value">{{ stats.comp or 0 }}</div>
            <div class="kpi-label">Completadas</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card border-0 shadow-soft hoverable">
      <div class="card-body">
        <div class="kpi">
          <div class="kpi-icon danger"><i class="bi bi-exclamation-triangle"></i></div>
          <div>
            <div class="kpi-value">{{ stats.crit or 0 }}</div>
            <div class="kpi-label">Críticas</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Alta rápida -->
<div class="card border-0 shadow-soft mb-4 hoverable">
  <div class="card-body">
    <form class="row g-2 align-items-end" method="post" action="{{ url_for('tarea_nueva') }}">
      <div class="col-12 col-md-4">
        <label class="form-label">Título *</label>
        <input name="titulo" class="form-control" required maxlength="255" placeholder="Ej. Preparar informe semanal">
      </div>
      <div class="col-12 col-md-3">
        <label class="form-label">Vencimiento</label>
        <input type="date" name="fecha_vencimiento" class="form-control">
      </div>
      <div class="col-6 col-md-2">
        <label class="form-label">Prioridad</label>
        <select name="prioridad" class="form-select">
          <option value="baja">Baja</option>
          <option value="media" selected>Media</option>
          <option value="alta">Alta</option>
          <option value="critica">Crítica</option>
        </select>
      </div>
      <div class="col-6 col-md-2">
        <label class="form-label">Asignar</label>
        <select name="asignada_a" class="form-select">
          <option value="">—</option>
          {% for u in usuarios %}
            <option value="{{ u.id }}">{{ u.nombre }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12 col-md-1 d-grid">
        <button class="btn btn-primary"><i class="bi bi-plus-lg"></i></button>
      </div>
      <div class="col-12">
        <label class="form-label">Descripción</label>
        <textarea name="descripcion" rows="2" class="form-control" maxlength="1000" placeholder="Detalles breves…"></textarea>
      </div>
    </form>
  </div>
</div>

<!-- Filtros -->
<form class="card border-0 shadow-soft mb-3" method="get">
  <div class="card-body row g-2">
    <div class="col-12 col-md-3">
      <input class="form-control" name="q" placeholder="Buscar por título o descripción…" value="{{ filtros.q }}">
    </div>
    <div class="col-6 col-md-2">
      <select name="estado" class="form-select">
        <option value="">Todos</option>
        <option value="pendiente" {{ 'selected' if filtros.estado=='pendiente' }}>Pendiente</option>
        <option value="en_progreso" {{ 'selected' if filtros.estado=='en_progreso' }}>En progreso</option>
        <option value="completada" {{ 'selected' if filtros.estado=='completada' }}>Completada</option>
      </select>
    </div>
    <div class="col-6 col-md-2">
      <select name="prioridad" class="form-select">
        <option value="">Prioridad</option>
        {% for p in ['baja','media','alta','critica'] %}
          <option value="{{ p }}" {{ 'selected' if filtros.prioridad==p }}>{{ p|capitalize }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-3">
      <select name="asignada" class="form-select">
        <option value="">Asignada a</option>
        {% for u in usuarios %}
          <option value="{{ u.id }}" {{ 'selected' if filtros.asignada and filtros.asignada|int==u.id }}>{{ u.nombre }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-2 d-grid">
      <button class="btn btn-outline-primary"><i class="bi bi-search"></i> Filtrar</button>
    </div>

    {% if filtros.q or filtros.estado or filtros.prioridad or filtros.asignada %}
      <div class="col-12 mt-2">
        <div class="d-flex flex-wrap align-items-center gap-2">
          <span class="small text-muted-2">Filtros activos:</span>
          {% if filtros.q %}<span class="badge text-bg-light border">Búsqueda: “{{ filtros.q }}”</span>{% endif %}
          {% if filtros.estado %}<span class="badge text-bg-light border">Estado: {{ filtros.estado.replace('_',' ') }}</span>{% endif %}
          {% if filtros.prioridad %}<span class="badge text-bg-light border">Prioridad: {{ filtros.prioridad|capitalize }}</span>{% endif %}
          {% if filtros.asignada %}
            {% for u in usuarios %}
              {% if u.id == filtros.asignada|int %}
                <span class="badge text-bg-light border">Asignada: {{ u.nombre }}</span>
              {% endif %}
            {% endfor %}
          {% endif %}
          <a class="btn btn-sm btn-link" href="{{ url_for('index') }}">Limpiar filtros</a>
        </div>
      </div>
    {% endif %}
  </div>
</form>

<!-- Resumen y paginación superior -->
<div class="d-flex justify-content-between align-items-center mb-2">
  <div class="small text-muted-2">
    Total: <strong>{{ total }}</strong> resultados · Página <strong>{{ page }}</strong>
  </div>
  {% set pages = (total // per_page) + (1 if (total % per_page) else 0) %}
  {% if pages > 1 %}
    <nav>
      <ul class="pagination pagination-sm mb-0">
        {% set query = request.args.to_dict() %}
        {% set prev = page-1 %}
        {% set next = page+1 %}
        <li class="page-item {% if page <= 1 %}disabled{% endif %}">
          {% set _ = query.update({'page': 1}) %}
          <a class="page-link" href="?{{ query|urlencode }}">Primera</a>
        </li>
        <li class="page-item {% if page <= 1 %}disabled{% endif %}">
          {% set _ = query.update({'page': prev}) %}
          <a class="page-link" href="?{{ query|urlencode }}">&laquo;</a>
        </li>
        <li class="page-item disabled"><span class="page-link">{{ page }} / {{ pages }}</span></li>
        <li class="page-item {% if page >= pages %}disabled{% endif %}">
          {% set _ = query.update({'page': next}) %}
          <a class="page-link" href="?{{ query|urlencode }}">&raquo;</a>
        </li>
        <li class="page-item {% if page >= pages %}disabled{% endif %}">
          {% set _ = query.update({'page': pages}) %}
          <a class="page-link" href="?{{ query|urlencode }}">Última</a>
        </li>
      </ul>
    </nav>
  {% endif %}
</div>

<!-- Cards de tareas -->
<div class="row g-3">
  {% for t in tareas %}
    <div class="col-12 col-md-6 col-lg-4">
      {% include "_task_card.html" %}
    </div>
  {% else %}
    <div class="col-12">
      <div class="alert alert-info border-soft">Sin tareas que mostrar.</div>
    </div>
  {% endfor %}
</div>

{% endblock %}
